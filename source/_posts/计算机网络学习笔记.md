---
title: 计算机网络学习笔记
date: 2017-04-20 16:42:01
tags:
- 计算机基础
catalogies:
- 学习笔记
---

# 前言
关于《计算机网络 从顶向下方法》的一些读书笔记。

<!--more-->

# 计算机网络协议层次
有两种模型：

TCP/IP五层模型：

从顶向下分别为应用层、运输层、网络层、链路层、物理层。

OSI七层模型：

从顶向下分别为应用层、表示层、会话层、运输层、网络层、链路层、物理层。

消息数据由上直下逐层分装为报文、报文段、数据报、帧，通过传输后又自下而上的解析为消息数据。

# 应用层

看了这一章后我对应用层的理解就是：应用程序与系统之间的通信接口？ 系统将API封装以给应用程序调用，而此层的协议则就是规范化的API？（不知道正确与否）

这一层主要的协议有：

- SMTP|电子邮件
- Telnet|远程终端访问
- HTTP|Web
- FTP|文件传输

## HTTP 超文本传输协议（HyperText Transform Protocol）

这个还是很熟悉的，感觉书上也只讲了些基础的东西。

HTTP是客户端与服务端使用报文进行通信的协议，基于TCP传输。

HTTP报文分两种：请求报文、响应报文。

### 请求报文格式为：

```
请求行 //request line
首部行 //header line
...
实体主体 //entity body
```
其中常见的请求方法有GET、POST、PUT、HEAD、DELETE。

响应报文格式为：
```
状态行 //status line
首部行 //header line
...
实体主体 //entity body
```

### HTTP响应状态码[维基百科](https://zh.wikipedia.org/wiki/HTTP%E7%8A%B6%E6%80%81%E7%A0%81)：

*HTTP是无状态的*

- 1xx：临时响应，需要继续处理
- 2xx：成功
- 3xx：重定向
- 4xx：客户端错误
- 5xx：服务器错误

### 非持续连接和持续连接

- 非持续连接：每个TCP连接发送一个对象后就关闭，如一个网页的许多图片，使用非持续连接就会每个图片都分别建立一个TCP连接传输
- 持续连接：服务器在发送响应后保持连接打开，相同的客户端和服务器之间的后续请求和响应报文通过相同的连接传输

## FTP 文件传送协议

FTP协议也是基于TCP连接，与HTTP不同的地方在于它建立两条连接；一条用于控制连接，另一条用于数据连接。

- 控制连接用于两主机之间传输控制协议，如用户标示，口令，控制命令
- 数据连接用于实际发送一个文件

## DNS 域名系统

DNS实现了主机名到IP地址之间的转换的目录服务，运行在UDP协议上，使用53号端口。

DNS使用分布式设计，DNS分为：
1. 根DNS服务器： 名副其实的root
2. 顶级域服务器： 负责顶级域名如com，org，net，edu以及所有国家的顶级域名
3. 权威DNS服务器： 由公共可访问主机的组织机构提供，如亚马逊……

## P2P

P2P将普通的客户-服务端结构网络化，让所有参与分发的客户端都成为了服务端。

BitTorrent协议：
- 参与一个特定文件分发的所有对等方的集合成为洪流（chunk）
- 每个洪流具有一个特定的基础设施结构，追踪器（tracker），当一个对等方加入洪流时，向追踪器注册自己，并周期性通知追踪器自己仍处在洪流中
- 稀缺优先、分布式散列表

# 运输层

运输层为运行在不同主机上的进程之间提供了逻辑通信。

## 多路分解和多路复用

应用层用套接字（socket）与运输层进行连接。

将运输层报文段中的数据交付到正确的套接字的工作---*多路分解*

在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层---*多路复用*

## UDP 无连接的运输

### UDP特点

- 关于何时、发送什么数据的应用层控制更为精细。
- 无需连接建立
- 无连接状态
- 分组首部开销小（8字节）

### UDP报文段结构

32比特

源端口号 | 目的端口号
长度    | 检验和
应用数据

## TCP 面向连接的运输

首先来个三次握手和四次挥手

[图解](http://blog.csdn.net/whuslei/article/details/6667471/)

### 三次握手

1. 客户端向服务端发送一个报文段，SYN设为1，随机选择一个序号client_isn，
2. 服务端收到后，分配缓存和变量，SYN设为1，确认号设为 client_isn + 1， 选择自己的序号 server_isn 
3. 客户端收到后，分配缓存和变量，将server_isn + 1设为确认号， SYN设为0

### 四次挥手

1. 客户端（任一端）发送FIN信号
2. 服务端接受发送ACK表示确认
3. 服务端关闭连接发送FIN
4. 客户端接受发送ACK表示确认，关闭连接

### TCP报文段结构

![TCP报文段结构](https://camo.githubusercontent.com/cc4d7fb7c85dcddbb38e4c5b2b5daf796768a109/687474703a2f2f6f6d366179726166752e626b742e636c6f7564646e2e636f6d2f706f73742f756e6465727374616e642d7463702d7564702f43464336333134453442324644303339433435303832314439343645393345322e706e67)

#### 各字段意义

- 源端口和目的端口 Port

各占2个字节，共4个字节。
用来告知主机该报文段是来自哪里以及传送给哪个应用程序（应用程序绑定了端口）的。
进行 TCP 通讯时，客户端通常使用系统自动选择的临时端口号，而服务器则使用知名服务端口号。

- 序号 Sequence Number

占 4 个字节。
TCP 是面向字节流的，在一个 TCP 连接中传输的字节流中的每个字节都按照顺序编号。
例如 100 kb 的 HTML 文档数据，一共 102400 (100 * 1024) 个字节，那么每一个字节就都有了编号，整个文档的编号的范围是 0 ~ 102399。

序号字段值指的是本报文段所发送的数据的第一个字节的序号。
那么 100 的 HTML 文档分割成四个等分之后，
第一个 TCP 报文段包含的是第一个 25kb 的数据，0 ~ 25599 字节， 该报文的序号的值就是：0
第二个 TCP 报文段包含的是第二个 25kb 的数据，25600 ~ 51199 字节，该报文的序号的值就是：25600
......

根据 8 位 = 1 字节，那么 4 个字节可以表示的数值范围：[0, 2^32]，一共 2^32 (4294967296) 个序号。
序号增加到最大值的时候，下一个序号又回到了 0.
也就是说 TCP 协议可对 4GB 的数据进行编号，在一般情况下可保证当序号重复使用时，旧序号的数据早已经通过网络到达终点或者丢失了。

- 确认号 Acknowledgemt Number

占 4 个字节。
表示期望收到对方下一个报文段的序号值。
TCP 的可靠性，是建立在「每一个数据报文都需要确认收到」的基础之上的。
就是说，通讯的任何一方在收到对方的一个报文之后，都要发送一个相对应的「确认报文」，来表达确认收到。
那么，确认报文，就会包含确认号。
例如，通讯的一方收到了第一个 25kb 的报文，该报文的 序号值=0，那么就需要回复一个确认报文，其中的确认号 = 25600.

- 数据偏移 Offset

占 0.5 个字节 (4 位)。
这个字段实际上是指出了 TCP 报文段的首部长度 ，它指出了 TCP报文段的数据起始处 距离 TCP报文的起始处 有多远。（注意 数据起始处 和 报文起始处 的意思）

一个数据偏移量 = 4 byte，由于 4 位二进制数能表示的最大十进制数字是 15，因此数据偏移的最大值是 60 byte，这也侧面限制了 TCP 首部的最大长度。

- 保留 Reserved

占 0.75 个字节 (6 位)。
保留为今后使用，但目前应置为 0。

- 标志位 TCP Flags

标志位，一共有 6 个，分别占 1 位，共 6 位 。
每一位的值只有 0 和 1，分别表达不同意思。

- 紧急 URG (Urgent)

当 URG = 1 的时候，表示紧急指针（Urgent Pointer）有效。
它告诉系统此报文段中有紧急数据，应尽快传送，而不要按原来的排队顺序来传送。
URG 要与首部中的 紧急指针 字段配合使用。

- 确认 ACK (Acknowlegemt)

当 ACK = 1 的时候，确认号（Acknowledgemt Number）有效。
一般称携带 ACK 标志的 TCP 报文段为「确认报文段」。
TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 设置为 1。

- 推送 PSH (Push)

当 PSH = 1 的时候，表示该报文段高优先级，接收方 TCP 应该尽快推送给接收应用程序，而不用等到整个 TCP 缓存都填满了后再交付。

- 复位 RST (Reset)

当 RST = 1 的时候，表示 TCP 连接中出现严重错误，需要释放并重新建立连接。
一般称携带 RST 标志的 TCP 报文段为「复位报文段」。

- 同步 SYN (SYNchronization)

当 SYN = 1 的时候，表明这是一个请求连接报文段。
一般称携带 SYN 标志的 TCP 报文段为「同步报文段」。
在 TCP 三次握手中的第一个报文就是同步报文段，在连接建立时用来同步序号。
对方若同意建立连接，则应在响应的报文段中使 SYN = 1 和 ACK = 1。

- 终止 FIN (Finis)

当 FIN = 1 时，表示此报文段的发送方的数据已经发送完毕，并要求释放 TCP 连接。
一般称携带 FIN 的报文段为「结束报文段」。
在 TCP 四次挥手释放连接的时候，就会用到该标志。

- 窗口大小 Window Size

占 2 字节。
该字段明确指出了现在允许对方发送的数据量，它告诉对方本端的 TCP 接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。
窗口大小的值是指，从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。
例如，假如确认号是 701 ，窗口字段是 1000。这就表明，从 701 号算起，发送此报文段的一方还有接收 1000 （字节序号是 701 ~ 1700） 个字节的数据的接收缓存空间。

- 校验和 TCP Checksum

占 2 个字节。
由发送端填充，接收端对 TCP 报文段执行 CRC 算法，以检验 TCP 报文段在传输过程中是否损坏，如果损坏这丢弃。
检验范围包括首部和数据两部分，这也是 TCP 可靠传输的一个重要保障。

- 紧急指针 Urgent Pointer

占 2 个字节。
仅在 URG = 1 时才有意义，它指出本报文段中的紧急数据的字节数。
当 URG = 1 时，发送方 TCP 就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据。
因此，紧急指针指出了紧急数据的末尾在报文段中的位置。